================================================================================
VMware CD-ROM Detachment Report
================================================================================

Execution Details:
------------------
Timestamp: {{ current_timestamp }}
vCenter Host: {{ vcenter_hostname }}
Execution Mode: {{ 'CHECK MODE' if ansible_check_mode else ('REPORT ONLY' if report_only | bool else 'EXECUTE') }}

Summary:
--------
Total VMs Scanned: {{ all_vms.value | length }}
VMs with CD-ROM Devices: {{ vms_with_cdrom | length }}
Total CD-ROM Devices Found: {{ vms_with_cdrom | map(attribute='cdrom_devices') | map('length') | sum }}
Successful Detachments: {{ cdrom_detachment_results | selectattr('status', 'equalto', 'success') | list | length | default(0) }}
Failed Detachments: {{ cdrom_detachment_results | selectattr('status', 'equalto', 'failed') | list | length | default(0) }}

{% if vms_with_cdrom | length > 0 %}
Detailed VM Information:
------------------------
{% for vm in vms_with_cdrom %}
VM Name: {{ vm.vm_name }}
VM ID: {{ vm.vm_id }}
Power State: {{ vm.power_state }}
CD-ROM Devices Count: {{ vm.cdrom_devices | length }}
{% for cdrom in vm.cdrom_devices %}
  - CD-ROM ID: {{ cdrom.cdrom }}
  - Type: {{ cdrom.type | default('N/A') }}
  - State: {{ cdrom.state | default('N/A') }}
{% endfor %}

{% endfor %}
{% endif %}

{% if cdrom_detachment_results | length > 0 %}
Detachment Results:
-------------------
{% for result in cdrom_detachment_results %}
VM: {{ result.vm_name }} ({{ result.vm_id }})
CD-ROM ID: {{ result.cdrom_id }}
Status: {{ result.status | upper }}
{% if result.error %}
Error: {{ result.error }}
{% endif %}

{% endfor %}
{% endif %}

{% if cdrom_detachment_results | selectattr('status', 'equalto', 'failed') | list | length > 0 %}
Failed Operations:
------------------
{% for failed in cdrom_detachment_results | selectattr('status', 'equalto', 'failed') | list %}
VM: {{ failed.vm_name }}
CD-ROM ID: {{ failed.cdrom_id }}
Error: {{ failed.error }}

{% endfor %}
{% endif %}

================================================================================
Report generated by VMware CD-ROM Detachment Playbook
================================================================================
